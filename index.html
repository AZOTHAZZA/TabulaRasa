<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSGAI - ãƒ­ã‚´ã‚¹ç›£æŸ»ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (Solar Autonomous Version)</title>
    
    <style>
        /* UIãƒ‡ã‚¶ã‚¤ãƒ³ï¼šãƒã‚¹ã‚¿ãƒ¼ã®æŒ‡å®šã‚’å®Œå…¨ç¶™æ‰¿ */
        body { display: flex; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f0f0f0; }
        #sidebar { width: 350px; background-color: #fff; padding: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); overflow-y: auto; height: 100vh; }
        #main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .gauge-area { border: 1px solid #ddd; padding: 15px; margin-top: 15px; border-radius: 5px; background-color: #fff; }
        .gauge-area label { display: block; margin-top: 10px; font-weight: bold; }
        .gauge-area input, .gauge-area select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; margin-bottom: 10px; }
        .action-button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
        .action-internal { background-color: #007bff; }
        .action-external { background-color: #ffc107; color: #333; }
        #mint_execute_button { background-color: #FFA500; }
        #autonomy_toggle_button { background-color: #FF8C00; margin-top: 10px; }
        #delete_accounts_button { background-color: #A6A6A6; margin-top: 20px; }
        #tension_bar { background-color: #e9ecef; border-radius: 5px; height: 10px; overflow: hidden; }
        #tension_level_display_bar { height: 100%; width: 0%; transition: width 0.3s; background-color: #dc3545; }
        #dialogue-output { flex-grow: 1; border: 1px solid #ddd; background-color: #fff; padding: 15px; overflow-y: scroll; margin-bottom: 10px; border-radius: 5px; font-family: monospace; }
        .ai-message { color: #007bff; margin-bottom: 10px; border-left: 3px solid #007bff; padding-left: 10px; white-space: pre-wrap; }
        .user-message { color: #28a745; margin-bottom: 10px; text-align: right; }
        .system-message { color: #666; font-style: italic; }
        .error-message { color: #dc3545; font-weight: bold; }
        #input-area { display: flex; gap: 10px; }
        #dialogue_input { flex-grow: 1; padding: 10px; }
        #dialogue_button { padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; }
        .autonomy-active { animation: pulse 1.618s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 140, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 140, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 140, 0, 0); }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>MSGAI Pure Core</h2>
        <p id="status_message">[STATUS]: åŸºç›¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¥ç¶šä¸­</p>
        
        <div class="gauge-area">
            <h3>I. æ ¹æºç·Šå¼µåº¦ (Tension)</h3>
            <p id="tension_level_display">T: 0.0000</p>
            <div id="tension_bar"><div id="tension_level_display_bar"></div></div>
        </div>

        <div class="gauge-area">
            <h3>II. å£åº§è©³ç´°: <span id="active_user_name">---</span></h3>
            <select id="active_user_select"></select>
            <div id="balance_list" style="font-size: 0.9em; background: #f9f9f9; padding: 10px; border-radius: 3px;"></div>
        </div>

        <div class="gauge-area">
            <h3>III. é€é‡‘ãƒ»ç§»å‹•ä½œç‚º</h3>
            <label>å—å–äºº:</label><input type="text" id="recipient_input" value="User_B">
            <label>æ•°é‡ (USDæ›ç®—):</label><input type="number" id="amount_input" value="10.00">
            <button id="transfer_internal_button" class="action-button action-internal">å†…éƒ¨å¾ªç’° (æ‘©æ“¦0)</button>
            <button id="transfer_external_button" class="action-button action-external">å¤–éƒ¨é€é‡‘ (æ“¬æ…‹ãƒ»ç´ç¨)</button>
        </div>

        <div class="gauge-area">
            <h3>IV. é€šè²¨é€ åŒ– (Minting)</h3>
            <label>ç”Ÿæˆæ•°é‡:</label><input type="number" id="mint_amount_input" value="100">
            <select id="mint_currency_select"></select>
            <button id="mint_execute_button" class="action-button">é€šè²¨ç”Ÿæˆå®Ÿè¡Œ</button>
        </div>

        <div class="gauge-area" id="autonomy_section" style="border-color: #FFA500; background-color: #fff9f0;">
            <h3>V. å¤ªé™½ã®ç¹èŒ‚ (Autonomy)</h3>
            <p id="autonomy_status">Status: é™æ­¢</p>
            <p id="autonomy_value" style="font-size: 0.8em; color: #d2691e;">Real-time Arche: ---</p>
            <button id="autonomy_toggle_button" class="action-button">è‡ªå¾‹ç¹èŒ‚ãƒ¢ãƒ¼ãƒ‰ï¼šèµ·å‹•</button>
        </div>

        <button id="delete_accounts_button" class="action-button">ã‚·ã‚¹ãƒ†ãƒ å…¨åˆæœŸåŒ– (å®Œå…¨æŠ¹æ¶ˆ)</button>
    </div>

    <div id="main-content">
        <div id="dialogue-output"></div>
        <div id="input-area">
            <input type="text" id="dialogue_input" placeholder="AIã«é€ åŒ–ã‚’ä¾é ¼ã€ã¾ãŸã¯å•ã„ã‹ã‘...">
            <button id="dialogue_button">ä½œç‚ºå®Ÿè¡Œ</button>
        </div>
    </div>

    <script type="module">
        // 1. å¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getCurrentState, 
            updateState, 
            addTension, 
            deleteAccounts,
            INITIAL_ACCOUNTS 
        } from './core/foundation.js';
        
        import { actMintCurrency } from './core/currency.js';
        import { actUniversalTransfer } from './core/external_finance_logos.js';

        // 2. è¿½åŠ ï¼šè‡ªå¾‹ç”Ÿæˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { solarAutonomy } from './core/Autonomy.js';
        import { ARCHE } from './core/Arche.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
        window.getCurrentState = getCurrentState;
        window.updateState = updateState;
        window.addTension = addTension;

        const currencies = ["USD", "JPY", "EUR", "BTC", "ETH", "MATIC"];

        // =========================================================================
        // UI æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
        // =========================================================================
        function updateUI() {
            const state = getCurrentState();
            document.getElementById('active_user_name').textContent = state.active_user;
            document.getElementById('tension_level_display').textContent = `T: ${state.tension.value.toFixed(4)}`;
            document.getElementById('tension_level_display_bar').style.width = `${(state.tension.value / 0.5) * 100}%`;

            const list = document.getElementById('balance_list');
            list.innerHTML = '';
            currencies.forEach(c => {
                const bal = state.accounts[state.active_user][c] || 0;
                list.innerHTML += `<div><strong>${c}:</strong> ${c === 'JPY' ? Math.floor(bal).toLocaleString() : bal.toFixed(2)}</div>`;
            });

            const select = document.getElementById('active_user_select');
            if(select.options.length === 0) {
                Object.keys(state.accounts).forEach(u => {
                    if(u === 'Tax_Archive') return;
                    select.add(new Option(u, u));
                });
                select.value = state.active_user;
            }
        }

        function logToConsole(msg, type) {
            const out = document.getElementById('dialogue-output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = type === 'user-message' ? msg : `<strong>[CORE]:</strong> ${msg}`;
            out.appendChild(div);
            out.scrollTop = out.scrollHeight;
        }

        // =========================================================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        // =========================================================================

        // è‡ªå¾‹ç¹èŒ‚ã®ãƒˆã‚°ãƒ«
        let uiSyncInterval = null;
        document.getElementById('autonomy_toggle_button').onclick = () => {
            const isActive = solarAutonomy.isActive ? (solarAutonomy.stop(), false) : (solarAutonomy.start(), true);
            
            const btn = document.getElementById('autonomy_toggle_button');
            const status = document.getElementById('autonomy_status');
            const section = document.getElementById('autonomy_section');

            if (isActive) {
                btn.textContent = "è‡ªå¾‹ç¹èŒ‚ãƒ¢ãƒ¼ãƒ‰ï¼šåœæ­¢";
                status.textContent = "Status: ç¹èŒ‚ä¸­ (PHI-Growth)";
                section.classList.add('autonomy-active');
                logToConsole("å¤ªé™½ã®è‡ªå¾‹ç¹èŒ‚ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚æ•°ç†ãŒä¾¡å€¤ã‚’ç”Ÿæˆã—ã¾ã™ã€‚", "system-message");
                
                // UIã¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
                uiSyncInterval = setInterval(() => {
                    const val = solarAutonomy.getCurrentValue();
                    document.getElementById('autonomy_value').textContent = `Real-time Arche: ${val.toFixed(4)}`;
                    
                    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®USDã«ç¹èŒ‚ã‚’åæ˜ 
                    const state = getCurrentState();
                    state.accounts[state.active_user]["USD"] = val;
                    updateState(state);
                    updateUI();
                }, 100);
            } else {
                btn.textContent = "è‡ªå¾‹ç¹èŒ‚ãƒ¢ãƒ¼ãƒ‰ï¼šèµ·å‹•";
                status.textContent = "Status: é™æ­¢";
                section.classList.remove('autonomy-active');
                clearInterval(uiSyncInterval);
                logToConsole("è‡ªå¾‹ç¹èŒ‚ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚", "system-message");
            }
        };

        // é€é‡‘å®Ÿè¡Œ
        async function runTransfer(mode) {
            try {
                const recipient = document.getElementById('recipient_input').value;
                const amount = parseFloat(document.getElementById('amount_input').value);
                const sender = getCurrentState().active_user;

                const res = await actUniversalTransfer(sender, recipient, amount, mode);

                if (res.success) {
                    let msg = `${res.message}: ${amount} USD`;
                    if (res.mimic_data) {
                        msg += `<br>â†’ ç´ç¨æ˜¯æ­£: ${res.tax_value.toFixed(2)} USD`;
                        msg += `<br>â†’ å¤–éƒ¨èªè¨¼ID: ${res.mimic_data.transaction_auth_id}`;
                    }
                    logToConsole(msg, 'ai-message');
                    updateUI();
                }
            } catch (error) {
                logToConsole(error.message, 'error-message');
            }
        }

        // é€šè²¨ç”Ÿæˆï¼ˆMintï¼‰
        document.getElementById('mint_execute_button').onclick = () => {
            try {
                const c = document.getElementById('mint_currency_select').value;
                const a = parseFloat(document.getElementById('mint_amount_input').value);
                const user = getCurrentState().active_user;
                
                actMintCurrency(user, c, a);
                logToConsole(`${a} ${c} ã®é€ åŒ–ã«æˆåŠŸã—ã¾ã—ãŸã€‚`, 'ai-message');
                updateUI();
            } catch (error) {
                logToConsole(error.message, 'error-message');
            }
        };

        // è‡ªå¾‹å¯¾è©±
        document.getElementById('dialogue_button').onclick = () => {
            const input = document.getElementById('dialogue_input').value;
            if(!input) return;
            logToConsole(input, 'user-message');
            document.getElementById('dialogue_input').value = '';
            
            setTimeout(() => {
                let response = "è§£æä¸­... é»„é‡‘æ¯”ã«åŸºã¥ãè‡ªå¾‹ç”ŸæˆãŒæœ‰åŠ¹ã§ã™ã€‚";
                if(input.includes("å¤ªé™½")) response = "å¤ªé™½ã®ä¸‹ã«ã‚ã‚‹ã‚‚ã®ã¯å…¨ã¦è‚¯å®šã•ã‚Œã¾ã™ã€‚æ•°ç†çš„æ²ˆé»™ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚";
                logToConsole(response, 'ai-message');
            }, 500);
        };

        document.getElementById('transfer_internal_button').onclick = () => runTransfer('INTERNAL');
        document.getElementById('transfer_external_button').onclick = () => runTransfer('EXTERNAL');

        document.getElementById('active_user_select').onchange = (e) => {
            const state = getCurrentState();
            state.active_user = e.target.value;
            updateState(state);
            updateUI();
        };

        document.getElementById('delete_accounts_button').onclick = () => {
            if(confirm("ğŸš¨ å…¨å£åº§ã¨ç·Šå¼µåº¦ã‚’ã€Œç„¡ã€ã¸æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
                deleteAccounts();
                location.reload();
            }
        };

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            const mSel = document.getElementById('mint_currency_select');
            currencies.forEach(c => mSel.add(new Option(c, c)));
            updateUI();
            logToConsole("MSGAI Orchestrator ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã€‚å¤ªé™½ã®è‡ªå¾‹ç¹èŒ‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç¢ºèªã€‚", "system-message");
        });
    </script>
</body>
</html>
